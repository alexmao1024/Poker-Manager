<view class="screen">
  <view class="rules-fab" bindtap="openRules" wx:if="{{isStarted}}">规则</view>
  <view class="rules-fab guide-fab" bindtap="openHostGuide" wx:if="{{isHost}}">房主流程</view>
  <view class="stack">
    <view class="panel header fade-in">
      <view class="row">
        <view>
          <view class="title-sm">房间号</view>
          <view class="subtitle">#{{table.code}} · {{roundLabel}}</view>
        </view>
        <view class="pot pot-hero">
          <view class="pot-label">底池积分</view>
          <view class="pot-value">{{displayPot}}</view>
        </view>
      </view>
      <view class="meta">
        <view class="stage-pill">当前阶段 {{roundLabel}}</view>
        <text>行动 {{currentPlayer.name}}</text>
        <text>{{table.gameType === "zhajinhua" ? "当前注" : "最高积分"}} {{currentBet}}</text>
      </view>
      <view class="blind-row" wx:if="{{table.gameType !== 'zhajinhua'}}">
        <text>庄家 {{dealerPlayer.name}}</text>
        <text>小盲 {{smallBlindPlayer.name}} / {{table.blinds.sb}}</text>
        <text>大盲 {{bigBlindPlayer.name}} / {{table.blinds.bb}}</text>
      </view>
      <view class="blind-row" wx:else>
        <text>庄家 {{dealerPlayer.name}}</text>
        <text>底注 {{table.gameRules.baseBet}}</text>
        <text>轮数 {{table.zjhRoundCount}} / {{table.gameRules.maxRounds}}</text>
      </view>
    </view>

    <view class="panel players fade-in delay-1">
      <view class="row table-head">
        <view class="section-title">玩家状态</view>
        <view class="tag">顺序行动</view>
      </view>
      <view class="player-grid">
        <view
          wx:for="{{playersView}}"
          wx:key="id"
          class="player-card {{item.isTurn ? 'is-turn' : ''}} {{item.statusClass}}"
        >
          <view class="row player-head">
            <view class="player-info">
              <image
                wx:if="{{item.avatar}}"
                class="player-avatar"
                src="{{item.avatar}}"
                mode="aspectFill"
                data-id="{{item.id}}"
                data-source="{{item.avatarSource}}"
                binderror="onAvatarError"
              />
              <view wx:else class="player-avatar avatar-fallback">{{item.nameInitial}}</view>
            </view>
            <view class="tag-group">
              <view wx:if="{{item.positionTag}}" class="tag tag-soft">{{item.positionTag}}</view>
              <view wx:if="{{item.seenLabel}}" class="tag tag-soft">{{item.seenLabel}}</view>
              <view wx:if="{{item.isMine}}" class="tag tag-mine">我</view>
              <view class="tag">{{item.statusLabel}}</view>
            </view>
          </view>
          <view class="player-meta">
            <text>积分 {{item.stack}}</text>
            <text>
              {{table.gameType === "zhajinhua" ? "本局出" : "本轮出"}} {{item.displayBet}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <view class="panel actions fade-in delay-2">
      <view class="row action-head">
        <view class="section-title">当前操作</view>
        <view class="tag">{{currentPlayer.name}}</view>
      </view>
      <view class="action-info">
        <text>需跟积分 {{displayCallNeed}}</text>
        <text>剩余积分 {{currentPlayer.stack}}</text>
        <text wx:if="{{table.gameType === 'zhajinhua'}}">{{currentPlayer.seen ? "已看牌" : "闷牌中"}}</text>
      </view>
      <view wx:if="{{canAct}}">
        <view wx:if="{{table.gameType !== 'zhajinhua'}}">
          <view class="action-buttons">
            <button class="btn btn-ghost" bindtap="onFold" disabled="{{!canFold}}">弃牌</button>
            <button class="btn btn-ghost" bindtap="onCheckCall">
              {{callNeed > 0 ? "跟积分" : "过牌"}}
            </button>
            <button class="btn btn-ghost" bindtap="onAllIn" disabled="{{!canAllIn}}">
              全下
            </button>
          </view>
          <view class="raise">
            <view class="raise-block">
              <text class="raise-subtitle">快捷出积分（点击后直接确认，按本次出分自动判断跟注/加注）</text>
              <view class="quick-raise">
                <view
                  wx:for="{{quickRaiseOptions}}"
                  wx:key="amount"
                  class="quick-btn"
                  data-amount="{{item.amount}}"
                  bindtap="onQuickRaise"
                >
                  {{item.label}}
                </view>
              </view>
            </view>
            <view class="raise-block">
              <text class="raise-subtitle">自定义出积分（到多少注）</text>
              <view class="form-row">
                <text class="form-label">出积分到</text>
                <input class="form-input" type="number" value="{{raiseTo}}" bindinput="onInputRaise" />
              </view>
              <button class="btn btn-primary" bindtap="onRaise">按输入出积分</button>
            </view>
          </view>
        </view>
        <view wx:else>
          <view class="action-buttons">
            <button class="btn btn-ghost" bindtap="onFold" disabled="{{!canFold}}">弃牌</button>
            <button class="btn btn-ghost" bindtap="onCheckCall">
              {{currentPlayer.seen ? "明跟" : "闷跟"}}
            </button>
            <button class="btn btn-ghost" bindtap="onSee" disabled="{{!canSee}}">
              看牌
            </button>
            <button class="btn btn-ghost" bindtap="openCompare" disabled="{{!canCompare}}">
              比牌
            </button>
            <button class="btn btn-ghost" bindtap="onAllIn" disabled="{{!canAllIn}}">
              全下
            </button>
          </view>
          <view class="raise">
            <view class="raise-block">
              <text class="raise-subtitle">快捷出分（点击后直接确认，自动判断跟注/加注）</text>
              <view class="quick-raise">
                <view
                  wx:for="{{quickRaiseOptions}}"
                  wx:key="amount"
                  class="quick-btn"
                  data-amount="{{item.amount}}"
                  bindtap="onQuickRaise"
                >
                  {{item.label}}
                </view>
              </view>
            </view>
            <view class="raise-block">
              <text class="raise-subtitle">自定义加注</text>
              <view class="form-row">
                <text class="form-label">本次追加</text>
                <input class="form-input" type="number" value="{{raiseTo}}" bindinput="onInputRaise" />
              </view>
              <text class="raise-note">
                快捷按钮表示“本次实际出分”，会自动判断跟注或加注；自定义输入用于加注（实际扣分）。
                明牌请直接输入你实际要付的分数，系统仅按规则折算为名义注
              </text>
              <button class="btn btn-primary" bindtap="onRaise">按输入加注</button>
            </view>
          </view>
        </view>
      </view>
      <view wx:else class="action-wait">
        {{waitActionText}}
      </view>
    </view>

    <view class="panel control fade-in delay-3">
      <view class="row control-buttons">
        <button
          class="btn btn-ghost {{table.round === 'showdown' ? (canSettle ? '' : 'is-disabled') : (canAdvanceStage ? '' : 'is-disabled')}}"
          bindtap="onStageAction"
        >
          {{stageActionLabel}}
        </button>
        <button class="btn btn-ghost" bindtap="resetHand" disabled="{{!canStartNextRound}}">新一回合</button>
        <button
          wx:if="{{isHost && table.gameType === 'zhajinhua' && table.round !== 'showdown'}}"
          class="btn btn-ghost"
          bindtap="openZhjCompareRules"
        >
          比牌限制
        </button>
        <button
          wx:if="{{isHost && table.gameType === 'zhajinhua' && canStartNextRound}}"
          class="btn btn-ghost"
          bindtap="openNextAnteSponsor"
        >
          下手代下底
        </button>
        <button wx:if="{{isHost && isStarted}}" class="btn btn-ghost" bindtap="openAdjustChips">积分修正</button>
        <button wx:if="{{canRebuy}}" class="btn btn-ghost" bindtap="openRebuy">补码</button>
        <button class="btn btn-ghost" open-type="share">分享房间</button>
        <button wx:if="{{isHost}}" class="btn btn-primary" bindtap="goSummary">结束房间</button>
        <button wx:else class="btn btn-primary" bindtap="leaveRoom">退出房间</button>
      </view>
      <view wx:if="{{table.gameType === 'zhajinhua' && zjhNextAnteSponsorName}}" class="raise-note">
        下一手代下底：{{zjhNextAnteSponsorName}}
      </view>
      <view wx:if="{{table.gameType === 'zhajinhua' && isStarted && table.round !== 'showdown'}}" class="raise-note">
        比牌限制：{{zjhBanCompareWhenDark ? "有闷牌禁比" : "按默认规则"}}
        {{zjhBanCompareWhenDark ? "（仅剩两人一明一闷可比）" : ""}}
      </view>
    </view>
  </view>

  <view wx:if="{{showRules}}" class="rules-modal" bindtap="closeRules">
    <view class="rules-card" catchtap="noop">
      <view class="modal-title">牌力说明</view>
      <image
        wx:if="{{table.gameType !== 'zhajinhua'}}"
        class="rules-image"
        src="{{texasRulesImageSrc}}"
        mode="widthFix"
      />
      <image wx:else class="rules-image" src="{{zhjRulesImageSrc}}" mode="widthFix" />
      <view wx:if="{{table.gameType === 'zhajinhua'}}" class="rules-text">
        <view>特殊牌型：非同花 2-3-5 大于豹子。</view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeRules">关闭</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showHostGuide}}" class="rules-modal" bindtap="closeHostGuide">
    <view class="rules-card" catchtap="noop">
      <view class="modal-title">房主流程</view>
      <view class="guide-list">
        <view wx:if="{{table.gameType !== 'zhajinhua'}}">
          <view class="guide-item"><text class="guide-index">1.</text><text>确认座位顺序，庄/盲位显示在左上。</text></view>
          <view class="guide-item"><text class="guide-index">2.</text><text>开局后系统自动扣盲，按顺序行动；快捷区是“本次出多少积分”，自定义是“到多少注”。</text></view>
          <view class="guide-item"><text class="guide-index">3.</text><text>进入摊牌后点“收积分”，按主池/侧池选择赢家（可多人平分）。</text></view>
          <view class="guide-item"><text class="guide-index">4.</text><text>收完积分后大家可点“补码”；房主可用“积分修正”处理喜钱/纠错。</text></view>
          <view class="guide-item"><text class="guide-index">5.</text><text>准备好后房主点“新一回合”，结束整局点“结束房间”。</text></view>
        </view>
        <view wx:else>
          <view class="guide-item"><text class="guide-index">1.</text><text>确认座位顺序，庄位显示在左上。</text></view>
          <view class="guide-item"><text class="guide-index">2.</text><text>开局后系统自动收底注，庄家先行动；房主可用“比牌限制”调整本手比牌规则。</text></view>
          <view class="guide-item"><text class="guide-index">3.</text><text>封顶轮数或只剩一人进入开牌；房主可用“积分修正”处理喜钱/纠错。</text></view>
          <view class="guide-item"><text class="guide-index">4.</text><text>开牌后点击“收积分”，按主池/侧池选择赢家。</text></view>
          <view class="guide-item"><text class="guide-index">5.</text><text>收完积分后可补码；房主可设“下手代下底”，再点“新一回合”。</text></view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-primary" bindtap="closeHostGuide">知道了</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showSettle}}" class="rules-modal" bindtap="closeSettle">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">选择收积分玩家</view>
      <view class="settle-hint">每个底池都要选赢家</view>
      <view class="settle-note">
        <text>主池：所有未弃牌玩家可争</text>
        <text>侧池：仅全下后仍可继续下注的玩家可争</text>
        <text>系统会自动合并可争玩家相同的侧池</text>
      </view>
      <view class="settle-list">
        <view
          wx:for="{{settlePots}}"
          wx:for-item="pot"
          wx:for-index="potIndex"
          wx:key="potIndex"
          class="settle-pot"
        >
          <view class="row settle-pot-head">
            <text>{{potIndex === 0 ? "主池" : ("侧池" + potIndex)}}</text>
            <text class="settle-amount">{{pot.amount}}</text>
          </view>
          <view class="settle-eligible">
            <view
              wx:for="{{pot.eligible}}"
              wx:for-item="player"
              wx:for-index="playerIndex"
              wx:key="id"
              class="settle-chip {{player.selected ? 'is-selected' : ''}}"
              data-potindex="{{potIndex}}"
              data-id="{{player.id}}"
              bindtap="togglePotWinner"
            >
              {{player.name}}
            </view>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeSettle">取消</button>
        <button class="btn btn-primary" bindtap="confirmSettle">
          确认收积分
        </button>
      </view>
    </view>
  </view>

  <view wx:if="{{showCompare}}" class="rules-modal" bindtap="closeCompare">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">选择比牌对象</view>
      <view class="settle-hint">比牌平局默认发起者输</view>
      <view class="settle-eligible">
        <view
          wx:for="{{compareTargets}}"
          wx:key="id"
          class="settle-chip {{compareTargetId === item.id ? 'is-selected' : ''}}"
          data-id="{{item.id}}"
          bindtap="selectCompareTarget"
        >
          {{item.name}}
        </view>
      </view>
      <view class="compare-result">
        <view
          class="settle-chip {{compareResult === 'win' ? 'is-selected' : ''}}"
          data-result="win"
          bindtap="selectCompareResult"
        >
          我赢
        </view>
        <view
          class="settle-chip {{compareResult === 'lose' ? 'is-selected' : ''}}"
          data-result="lose"
          bindtap="selectCompareResult"
        >
          我输
        </view>
        <view
          class="settle-chip {{compareResult === 'tie' ? 'is-selected' : ''}}"
          data-result="tie"
          bindtap="selectCompareResult"
        >
          平局
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeCompare">取消</button>
        <button class="btn btn-primary" bindtap="confirmCompare">
          确认比牌
        </button>
      </view>
    </view>
  </view>

  <view wx:if="{{showRebuy}}" class="rules-modal" bindtap="closeRebuy">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">补码</view>
      <view class="settle-hint">单次上限 {{rebuyLimit > 0 ? rebuyLimit : "不限"}}</view>
      <view class="form-row">
        <text class="form-label">补码金额</text>
        <input class="form-input" type="number" value="{{rebuyAmount}}" bindinput="onRebuyInput" />
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeRebuy">取消</button>
        <button class="btn btn-primary" bindtap="confirmRebuy">确认</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showAdjustChips}}" class="rules-modal" bindtap="closeAdjustChips">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">积分修正（房主）</view>
      <view class="settle-hint">用于喜钱、口头约定和临时纠错。正数加分，负数改为“扣分”模式。</view>
      <view class="form-row">
        <text class="form-label">选择玩家</text>
      </view>
      <view class="settle-eligible">
        <view
          wx:for="{{hostAdjustTargets}}"
          wx:key="id"
          class="settle-chip {{adjustChipTargetId === item.id ? 'is-selected' : ''}}"
          data-id="{{item.id}}"
          bindtap="selectAdjustChipTarget"
        >
          {{item.name}}（{{item.stack}}）
        </view>
      </view>
      <view class="form-row">
        <text class="form-label">修正方向</text>
      </view>
      <view class="compare-result">
        <view
          class="settle-chip {{adjustChipMode === 'add' ? 'is-selected' : ''}}"
          data-mode="add"
          bindtap="selectAdjustChipMode"
        >
          加分
        </view>
        <view
          class="settle-chip {{adjustChipMode === 'sub' ? 'is-selected' : ''}}"
          data-mode="sub"
          bindtap="selectAdjustChipMode"
        >
          扣分
        </view>
      </view>
      <view class="form-row">
        <text class="form-label">修正数值</text>
        <input class="form-input" type="number" value="{{adjustChipAmount}}" bindinput="onAdjustChipAmountInput" />
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeAdjustChips">取消</button>
        <button class="btn btn-primary" bindtap="confirmAdjustChips">确认修正</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showZhjCompareRules}}" class="rules-modal" bindtap="closeZhjCompareRules">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">比牌限制（炸金花）</view>
      <view class="settle-hint">房主可按本手玩法限制比牌。新一手开局后会恢复默认规则。</view>
      <view class="form-row">
        <text class="form-label">有闷牌时禁止比牌</text>
      </view>
      <view class="compare-result">
        <view
          class="settle-chip {{zjhBanCompareWhenDark ? 'is-selected' : ''}}"
          bindtap="toggleZhjBanCompareWhenDark"
        >
          {{zjhBanCompareWhenDark ? "已开启" : "已关闭"}}
        </view>
      </view>
      <view class="raise-note">
        说明：开启后，场上只要还有闷牌玩家就不能比牌；但仅剩两人且一明一闷时允许比牌。
      </view>
      <view class="modal-actions">
        <button class="btn btn-primary" bindtap="confirmZhjCompareRules">确认</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showNextAnteSponsor}}" class="rules-modal" bindtap="closeNextAnteSponsor">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">下一手代下底（炸金花）</view>
      <view class="settle-hint">选中后，下一手开局将由该玩家代缴全场底注。可清除设置。</view>
      <view class="settle-eligible">
        <view
          class="settle-chip {{!nextAnteSponsorTargetId ? 'is-selected' : ''}}"
          data-id=""
          bindtap="selectNextAnteSponsorTarget"
        >
          不设置
        </view>
        <view
          wx:for="{{nextAnteSponsorTargets}}"
          wx:key="id"
          class="settle-chip {{nextAnteSponsorTargetId === item.id ? 'is-selected' : ''}}"
          data-id="{{item.id}}"
          bindtap="selectNextAnteSponsorTarget"
        >
          {{item.name}}（{{item.stack}}）
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeNextAnteSponsor">取消</button>
        <button class="btn btn-primary" bindtap="confirmNextAnteSponsor">确认</button>
      </view>
    </view>
  </view>
</view>
