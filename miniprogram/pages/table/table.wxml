<view class="screen">
  <view class="rules-fab" bindtap="openRules" wx:if="{{isStarted}}">规则</view>
  <view class="rules-fab guide-fab" bindtap="openHostGuide" wx:if="{{isHost}}">房主流程</view>
  <view class="stack">
    <view class="panel header fade-in">
      <view class="row">
        <view>
          <view class="title-sm">房间号</view>
          <view class="subtitle">#{{table.code}} · {{roundLabel}}</view>
        </view>
        <view class="pot pot-hero">
          <view class="pot-label">底池积分</view>
          <view class="pot-value">{{displayPot}}</view>
        </view>
      </view>
      <view class="meta">
        <view class="stage-pill">当前阶段 {{roundLabel}}</view>
        <text>行动 {{currentPlayer.name}}</text>
        <text>{{table.gameType === "zhajinhua" ? "当前注" : "最高积分"}} {{currentBet}}</text>
      </view>
      <view class="blind-row" wx:if="{{table.gameType !== 'zhajinhua'}}">
        <text>庄家 {{dealerPlayer.name}}</text>
        <text>小盲 {{smallBlindPlayer.name}} / {{table.blinds.sb}}</text>
        <text>大盲 {{bigBlindPlayer.name}} / {{table.blinds.bb}}</text>
      </view>
      <view class="blind-row" wx:else>
        <text>庄家 {{dealerPlayer.name}}</text>
        <text>底注 {{table.gameRules.baseBet}}</text>
        <text>轮数 {{table.zjhRoundCount}} / {{table.gameRules.maxRounds}}</text>
      </view>
    </view>

    <view class="panel players fade-in delay-1">
      <view class="row table-head">
        <view class="section-title">玩家状态</view>
        <view class="tag">顺序行动</view>
      </view>
      <view class="player-grid">
        <view
          wx:for="{{playersView}}"
          wx:key="id"
          class="player-card {{item.isTurn ? 'is-turn' : ''}} {{item.statusClass}}"
        >
          <view class="row player-head">
            <view class="player-info">
              <image
                wx:if="{{item.avatar}}"
                class="player-avatar"
                src="{{item.avatar}}"
                mode="aspectFill"
                data-id="{{item.id}}"
                data-source="{{item.avatarSource}}"
                binderror="onAvatarError"
              />
              <view wx:else class="player-avatar avatar-fallback">{{item.nameInitial}}</view>
            </view>
            <view class="tag-group">
              <view wx:if="{{item.positionTag}}" class="tag tag-soft">{{item.positionTag}}</view>
              <view wx:if="{{item.seenLabel}}" class="tag tag-soft">{{item.seenLabel}}</view>
              <view wx:if="{{item.isMine}}" class="tag tag-mine">我</view>
              <view class="tag">{{item.statusLabel}}</view>
            </view>
          </view>
          <view class="player-meta">
            <text>积分 {{item.stack}}</text>
            <text>
              {{table.gameType === "zhajinhua" ? "本局出" : "本轮出"}} {{item.displayBet}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <view class="panel actions fade-in delay-2">
      <view class="row action-head">
        <view class="section-title">当前操作</view>
        <view class="tag">{{currentPlayer.name}}</view>
      </view>
      <view class="action-info">
        <text>需跟积分 {{displayCallNeed}}</text>
        <text>剩余积分 {{currentPlayer.stack}}</text>
        <text wx:if="{{table.gameType === 'zhajinhua'}}">{{currentPlayer.seen ? "已看牌" : "闷牌中"}}</text>
        <text wx:if="{{turnLeft > 0}}">倒计时 {{turnLeft}}s</text>
        <text wx:elif="{{table.actionTimeoutSec === 0}}">倒计时 关闭</text>
      </view>
      <view wx:if="{{canAct}}">
        <view wx:if="{{table.gameType !== 'zhajinhua'}}">
          <view class="action-buttons">
            <button class="btn btn-ghost" bindtap="onFold" disabled="{{!canFold}}">弃牌</button>
            <button class="btn btn-ghost" bindtap="onCheckCall">
              {{callNeed > 0 ? "跟积分" : "过牌"}}
            </button>
            <button class="btn btn-ghost" bindtap="onAllIn" disabled="{{!canAllIn}}">
              全下
            </button>
          </view>
          <view class="raise">
            <view class="form-row">
              <text class="form-label">出积分到</text>
              <input class="form-input" type="number" value="{{raiseTo}}" bindinput="onInputRaise" />
            </view>
            <view class="quick-raise">
              <view class="quick-btn" data-amount="5" bindtap="onQuickRaise">5</view>
              <view class="quick-btn" data-amount="10" bindtap="onQuickRaise">10</view>
              <view class="quick-btn" data-amount="20" bindtap="onQuickRaise">20</view>
              <view class="quick-btn" data-amount="50" bindtap="onQuickRaise">50</view>
              <view class="quick-btn" data-amount="100" bindtap="onQuickRaise">100</view>
              <view class="quick-btn" data-amount="500" bindtap="onQuickRaise">500</view>
            </view>
            <button class="btn btn-primary" bindtap="onRaise">出积分</button>
          </view>
        </view>
        <view wx:else>
          <view class="action-buttons">
            <button class="btn btn-ghost" bindtap="onFold" disabled="{{!canFold}}">弃牌</button>
            <button class="btn btn-ghost" bindtap="onCheckCall">
              {{currentPlayer.seen ? "明跟" : "闷跟"}}
            </button>
            <button class="btn btn-ghost" bindtap="onSee" disabled="{{!canSee}}">
              看牌
            </button>
            <button class="btn btn-ghost" bindtap="openCompare" disabled="{{!canCompare}}">
              比牌
            </button>
            <button class="btn btn-ghost" bindtap="onAllIn" disabled="{{!canAllIn}}">
              全下
            </button>
          </view>
          <view class="raise">
            <view class="form-row">
              <text class="form-label">加注到</text>
              <input class="form-input" type="number" value="{{raiseTo}}" bindinput="onInputRaise" />
            </view>
            <view class="quick-raise">
              <view class="quick-btn" data-amount="5" bindtap="onQuickRaise">5</view>
              <view class="quick-btn" data-amount="10" bindtap="onQuickRaise">10</view>
              <view class="quick-btn" data-amount="20" bindtap="onQuickRaise">20</view>
              <view class="quick-btn" data-amount="50" bindtap="onQuickRaise">50</view>
              <view class="quick-btn" data-amount="100" bindtap="onQuickRaise">100</view>
              <view class="quick-btn" data-amount="200" bindtap="onQuickRaise">200</view>
            </view>
            <button class="btn btn-primary" bindtap="onRaise">加注</button>
          </view>
        </view>
      </view>
      <view wx:else class="action-wait">
        {{table.round === "showdown" ? "等待房主收积分" : "等待轮到你"}}
      </view>
    </view>

    <view class="panel control fade-in delay-3">
      <view class="row control-buttons">
        <button
          class="btn btn-ghost {{table.round === 'showdown' ? (canSettle ? '' : 'is-disabled') : (canAdvanceStage ? '' : 'is-disabled')}}"
          bindtap="onStageAction"
        >
          {{stageActionLabel}}
        </button>
        <button class="btn btn-ghost" bindtap="resetHand" disabled="{{!canStartNextRound}}">新一回合</button>
        <button wx:if="{{canRebuy}}" class="btn btn-ghost" bindtap="openRebuy">补码</button>
        <button class="btn btn-ghost" open-type="share">分享房间</button>
        <button wx:if="{{isHost}}" class="btn btn-primary" bindtap="goSummary">结束房间</button>
        <button wx:else class="btn btn-primary" bindtap="leaveRoom">退出房间</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showRules}}" class="rules-modal" bindtap="closeRules">
    <view class="rules-card" catchtap="noop">
      <view class="modal-title">牌力说明</view>
      <image wx:if="{{table.gameType !== 'zhajinhua'}}" class="rules-image" src="/assets/hand-ranks.png" mode="widthFix" />
      <view wx:else class="rules-text">
        <view>同花顺 &gt; 豹子 &gt; 同花 &gt; 顺子 &gt; 对子 &gt; 单张</view>
        <view>特殊牌型：非同花 2-3-5 大于豹子</view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeRules">关闭</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showHostGuide}}" class="rules-modal" bindtap="closeHostGuide">
    <view class="rules-card" catchtap="noop">
      <view class="modal-title">房主流程</view>
      <view class="guide-list">
        <view wx:if="{{table.gameType !== 'zhajinhua'}}">
          <view class="guide-item"><text class="guide-index">1.</text><text>确认座位顺序，庄/盲位显示在左上。</text></view>
          <view class="guide-item"><text class="guide-index">2.</text><text>开局后系统自动扣盲，按顺序行动。</text></view>
          <view class="guide-item"><text class="guide-index">3.</text><text>进入摊牌后点击“收积分”，选择赢家。</text></view>
          <view class="guide-item"><text class="guide-index">4.</text><text>收完积分后自动进入新一回合。</text></view>
          <view class="guide-item"><text class="guide-index">5.</text><text>结束对局时点击“结束房间”。</text></view>
        </view>
        <view wx:else>
          <view class="guide-item"><text class="guide-index">1.</text><text>确认座位顺序，庄位显示在左上。</text></view>
          <view class="guide-item"><text class="guide-index">2.</text><text>开局后系统自动收底注，庄家先行动。</text></view>
          <view class="guide-item"><text class="guide-index">3.</text><text>封顶轮数或只剩一人进入开牌。</text></view>
          <view class="guide-item"><text class="guide-index">4.</text><text>开牌后点击“收积分”，选择赢家。</text></view>
          <view class="guide-item"><text class="guide-index">5.</text><text>收完积分后进入新一回合。</text></view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-primary" bindtap="closeHostGuide">知道了</button>
      </view>
    </view>
  </view>

  <view wx:if="{{showSettle}}" class="rules-modal" bindtap="closeSettle">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">选择收积分玩家</view>
      <view class="settle-hint">每个底池都要选赢家</view>
      <view class="settle-list">
        <view
          wx:for="{{settlePots}}"
          wx:for-item="pot"
          wx:for-index="potIndex"
          wx:key="potIndex"
          class="settle-pot"
        >
          <view class="row settle-pot-head">
            <text>{{potIndex === 0 ? "主池" : ("侧池" + potIndex)}}</text>
            <text class="settle-amount">{{pot.amount}}</text>
          </view>
          <view class="settle-eligible">
            <view
              wx:for="{{pot.eligible}}"
              wx:for-item="player"
              wx:for-index="playerIndex"
              wx:key="id"
              class="settle-chip {{player.selected ? 'is-selected' : ''}}"
              data-potindex="{{potIndex}}"
              data-id="{{player.id}}"
              bindtap="togglePotWinner"
            >
              {{player.name}}
            </view>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeSettle">取消</button>
        <button class="btn btn-primary" bindtap="confirmSettle">
          确认收积分
        </button>
      </view>
    </view>
  </view>

  <view wx:if="{{showCompare}}" class="rules-modal" bindtap="closeCompare">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">选择比牌对象</view>
      <view class="settle-hint">比牌平局默认发起者输</view>
      <view class="settle-eligible">
        <view
          wx:for="{{compareTargets}}"
          wx:key="id"
          class="settle-chip {{compareTargetId === item.id ? 'is-selected' : ''}}"
          data-id="{{item.id}}"
          bindtap="selectCompareTarget"
        >
          {{item.name}}
        </view>
      </view>
      <view class="compare-result">
        <view
          class="settle-chip {{compareResult === 'win' ? 'is-selected' : ''}}"
          data-result="win"
          bindtap="selectCompareResult"
        >
          我赢
        </view>
        <view
          class="settle-chip {{compareResult === 'lose' ? 'is-selected' : ''}}"
          data-result="lose"
          bindtap="selectCompareResult"
        >
          我输
        </view>
        <view
          class="settle-chip {{compareResult === 'tie' ? 'is-selected' : ''}}"
          data-result="tie"
          bindtap="selectCompareResult"
        >
          平局
        </view>
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeCompare">取消</button>
        <button class="btn btn-primary" bindtap="confirmCompare">
          确认比牌
        </button>
      </view>
    </view>
  </view>

  <view wx:if="{{showRebuy}}" class="rules-modal" bindtap="closeRebuy">
    <view class="settle-card" catchtap="noop">
      <view class="modal-title">补码</view>
      <view class="settle-hint">单次上限 {{rebuyLimit > 0 ? rebuyLimit : "不限"}}</view>
      <view class="form-row">
        <text class="form-label">补码金额</text>
        <input class="form-input" type="number" value="{{rebuyAmount}}" bindinput="onRebuyInput" />
      </view>
      <view class="modal-actions">
        <button class="btn btn-ghost" bindtap="closeRebuy">取消</button>
        <button class="btn btn-primary" bindtap="confirmRebuy">确认</button>
      </view>
    </view>
  </view>
</view>
